# Universal Data Routing Architecture

## Core Philosophy
**The Mobile App NEVER speaks to NASA directly.**
All traffic is routed through our controlled infrastructure to ensure:
1.  **Strict Schema Enforcement**: The app only knows our cleaned JSON format.
2.  **CORS & Privacy**: Headers are stripped/added at the proxy level.
3.  **Caching**: Aggressive caching (Cloudflare Edge) reduces API keys usage and latency.
4.  **Offline-First**: Tier-A content is shipped inside the binary; everything else cleans up gracefully.

## Layers

### 1. Tier-A Layer (Static Edge)
*   **What**: Highly curated, popular objects (Sun, Moon, Planets, M31).
*   **Source**: `data/tier_a/*.json` (Generated by `scripts/seed_database.js`).
*   **Hosting**: Cloudflare Pages (`staticDataUrl`).
*   **Access**:
    *   App checks `https://astro-data.pages.dev/tier_a/sun.json`.
    *   If 200 OK -> Use it.
    *   If 404 -> Fallback to Layer 2.
*   **Update Strategy**: Run `seed_database.js` manually or via CI/CD to regenerate.

### 2. Universal Proxy Layer (Dynamic Worker)
*   **What**: Anything else (Search results, APOD, random galaxies).
*   **Source**: Cloudflare Worker (`backend-proxy`).
*   **Endpoints**:
    *   **GET /apod**: Fetches NASA APOD -> Normalizes -> Caches (12h).
    *   **GET /lookup?q={query}**: Searches NASA Image API -> Normalizes -> Caches (24h).
    *   **GET /image-proxy?url=...**: Proxies binary image data. **Crucial**: Adds `Cache-Control: immutable, max-age=1year`.

### 3. Image Handling
*   **The Problem**: NASA images often have redirect chains or strict CORS.
*   **The Solution**: The JSON returned by Layer 1 & 2 *never* contains a raw `nasa.gov` URL.
*   **Format**: `https://backend-proxy.workers.dev/image-proxy?url=<ENCODED_NASA_URL>`.
*   **Mobile App**:
    *   Uses `cached_network_image`.
    *   Since the URL is our proxy, the key is stable.
    *   The proxy returns aggressive cache headers, so the phone only downloads once.

## Expansion Plan
To add new features (e.g., Mars Rover Photos):
1.  **Do NOT** add a direct API call in Flutter.
2.  **Update Worker**: Add `GET /mars-photos`.
3.  **Logic**: Fetch from NASA -> Filter bad photos -> Return JSON list of Proxy URLs.
4.  **Update App**: Call `/mars-photos` via `NetworkService`.

This ensures the architecture remains pure as it scales.
