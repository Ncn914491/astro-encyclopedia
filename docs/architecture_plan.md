# Universal Data Routing Architecture (Simplified)

## Core Philosophy
**The Mobile App NEVER speaks to NASA directly.**
All traffic is routed through our Cloudflare Worker.

## Data Layers

### Layer 1: Local Bundle (APK)
- **What**: Pre-seeded Tier-A images and JSON.
- **Location**: `assets/offline/` folder in Flutter.
- **Generated by**: `scripts/seed_database.js`.
- **Access**: `Image.asset('assets/offline/sun.jpg')`.
- **Speed**: Instant (0ms network latency).

### Layer 2: Cloudflare Worker (Dynamic)
- **What**: Everything else (search, APOD, any galaxy).
- **Endpoints**:
  - `GET /apod` → NASA APOD, normalized.
  - `GET /lookup?q={query}` → NASA Image Search, normalized.
  - `GET /image-proxy?url={encoded_url}` → Binary image stream.
- **Caching**: Edge-cached globally.

### Layer 3: GitHub Pages (Optional Remote Backup)
- **What**: Same Tier-A JSON files, hosted remotely.
- **Use Case**: If you want to update Tier-A data without releasing a new APK.
- **URL**: `https://<user>.github.io/astro-encyclopedia/tier_a/sun.json`

## Image Handling

All `imageUrl` fields in JSON **never** point to NASA directly.

**Format**:
```
https://backend-proxy.workers.dev/image-proxy?url=<ENCODED_NASA_URL>
```

This allows:
1. CORS bypass.
2. Stable cache keys.
3. 1-year immutable caching on device.

## Expansion

To add new features (Mars Rover, Exoplanets):
1. Add a new route in `backend-proxy/src/index.ts`.
2. Normalize to the schema in `docs/api_contract.md`.
3. Call from Flutter via `NetworkService`.

**Never** add direct NASA API calls to the Flutter app.
